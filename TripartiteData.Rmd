---
title: "R Notebook"
output: html_notebook
---

The main question is whether there is a difference between cyano_moss_symbiosis and moss_alone / cyano_alone. To verify the existence of a symbiotic effect between cyano and moss, the change in weight at different pHs in different combinations of cyano and moss will be examined. Statistically significant differences in cyano_moss_symbiosis in comparison to moss_alone, cyano_alone, and cyano_moss_separate combinations are indicative of a beneficial efect in moss growth. The study conducted by Colleen Hulsey and Megan Gable in 2017 and 2018 will first be examined separately within years prior to growth being compared between the two years. 

Legend:
Cyano_alone = cyano by itself
Cyano_symbiosis = cyano growing with moss
Cyano_moss_separate = cyano and moss grown in same well but kept apart via filter
Cyano_moss_symbiosis = cyano and moss grown in same well
Moss_alone = moss by itself
Moss_symbiosis = cyano and moss grown in same well

*Main goal will be to collapse everything into 1 table and 1 figure*

# Data Import and ANOVA for 2017

```{r 2017 Sphagnum-Cyano Import}
library(tidyverse)

tri.2017 <- read.csv("~/Documents/Git/tripartite_symbiosis_paper/fallax_cyano_symbiosis_allyssa_colleen_2017.csv")
View(tri.2017)

tri.2017 <- tri.2017 %>% 
  select(pH = pH, condition = condition, delta_weight) %>%
  filter(pH == "3.5" | pH == "5.5" | pH == "8.5") %>% 
  filter(condition == "moss_alone" | condition == "cyano_alone" | condition == "Cyanobacteria_moss_symbiosis" | condition =="Cyanobacteria_moss_seperate")
View(tri.2017)
str(tri.2017)

tri.2017$pH <- factor(tri.2017$pH, 
                      levels = c(3.5, 5.5, 8.5), 
                      labels = c("pH_3.5", "pH_5.5", "pH_8.5"))

table(tri.2017$pH, tri.2017$condition) # balanced design
```

```{r 2017 Summary statistics and graphs}

tri.2017.sum <- tri.2017 %>% 
  group_by(pH, condition) %>%
  summarise(
    count = n(),
    mean = mean(delta_weight, na.rm = TRUE),
    sd = sd(delta_weight, na.rm = TRUE)
  ) %>% 
  arrange(condition, pH)
View(tri.2017.sum)

# double checking figures in Dave's notebook
ggplot(data = tri.2017.sum, aes(x = pH, y = mean, colour = condition)) + geom_point()
#shows that at all pH cyano_moss symbiosis is higher, suggesting a symbiotic relationship

# recreating Fig. 1
ggplot(data = tri.2017, aes(x = condition, y = delta_weight, colour = condition)) + geom_boxplot() + geom_point()

# recreating Fig. 2
ggplot(data = tri.2017, aes(x = condition, y = delta_weight, colour = condition)) + geom_boxplot() + geom_point() + facet_grid(. ~ pH)

# recreating Fig 3
ggplot(data = tri.2017, aes(x = pH, y = delta_weight)) + geom_boxplot() + geom_point()
```

Confirms similar info to 2018 data. Cyano & moss grown together have higher weight than grown separate or grown alone. Higher pHs correspond to produce higher growth with the symbiotic relationship increasing growth response as pH increases. 

```{r 2017 Two-way ANOVA}
# factors: condition * pH
tri.2017.aov <- aov(delta_weight ~ condition + pH + condition:pH, data = tri.2017)
summary(tri.2017.aov) # assumes factors are independent. same outcome as above. 

# Both condition and pH are significant in controlling growth, with condition being the most significant variable.the interaction term is not significant suggesting that pH and condition influence growth independently of each other

TukeyHSD(tri.2017.aov, which = c("condition", "pH")) 
# indicates that cyano_moss separate & cyano_moss symbiosis is nearly significant (p-value = 0.077). What drives the significant ANOVA appears to be the differences between cyano_moss_symbiosis and cyano_alone as well as the differences between cyano_moss_symbiosis and moss-alone. This confirms that grown together is more beneficial than grown apart and that being in proximity approximates being in contact (also better than being grown apart).
```

```{r 2017 Testing ANOVA assumptions}
# ANOVA assumption: data is normally distributed
plot(tri.2017.aov, 2)

## Shapiro-Wilk test - normality check
tri2017.residuals <- residuals(object = tri.2017.aov)
shapiro.test(x = tri2017.residuals) # p value is significant. normality is violated. data will need to be transformed.

# ANOVA assumption: variance across groups are homogeneous
plot(tri.2017.aov, 1) # funnel indicative of violation of homogeneous variance

## cannot use Bartlett's test for variance check because normality is violated

## Levene's test (more forgiving of departures from normal distribution)
library(car)
leveneTest(delta_weight ~ condition*pH, data = tri.2017) # p value is significant. variance across groups is not homogenous. 
```

```{r Nonparametric Tests}
# heteroscedasticity-corrected coefficient covariance matrix
library(car)
tri.2017.aovadjust <- Anova(tri.2017.aov, white.adjust = TRUE)

# Scheirer Ray Hare test
library(rcompanion)
tri.2017.srh <- scheirerRayHare(delta_weight ~ condition + pH, data = tri.2017)

```

# 2017 Data Transformations 
```{r 2017 Normality and Variance correction}
# delta_weight untransformed
weight <- tri.2017$delta_weight
View(weight)

hist(tri.2017$delta_weight)
qqnorm(weight)
qqline(weight, col = "red")
# positively skewed options: square root, cube root, and log

# square root transform
weight.sqrt <- sqrt(weight) # NAs produced bc negative numbers
hist(weight.sqrt)
qqnorm(weight.sqrt)
qqline(weight.sqrt, col = "red")

# include cube root just for comparison
weight.cubed <- sign(weight) * abs(weight)^(1/3)
hist(weight.cubed)
qqnorm(weight.cubed)
qqline(weight.cubed, col = "red")

# log transformation is more commonly used for size data
weight.log <- weight + 22.33 # attempting to make all values positive without changing relative differences
weight.log <- log10(weight.log)
View(weight.log)

hist(weight.log)
qqnorm(weight.log)
qqline(weight.log, col = "red")

# exponential transformation 
means <- aggregate(tri.2017$delta_weight, list(tri.2017$pH), mean)
vars <- aggregate(tri.2017$delta_weight, list(tri.2017$pH), var)

logmeans <- log10(means$x)
logvars <- log10(vars$x)

weight_mod <- lm(logvars ~ logmeans)
summary(weight_mod) # slope = 1.508940

# power = 1 - (b/2)
1 - (1.508940/2) # 0.24553
```

```{r 2017 Testing ANOVA - Square root}
# square root transformation

tri.2017.transformed <- cbind(tri.2017, weight.sqrt)
View(tri.2017.transformed)

tri.2017.trans.aov <- aov(weight.sqrt ~ condition + pH + condition:pH, data = tri.2017.transformed)
summary(tri.2017.trans.aov) # no change in outcome of ANOVA

## Shapiro-Wilk test - normality check
tri2017.transresiduals <- residuals(object = tri.2017.trans.aov)
shapiro.test(x = tri2017.transresiduals) # p value is insignificant. normality is not violated.

# ANOVA assumption: variance across groups are homogeneous
plot(tri.2017.trans.aov, 1) # slight funnel, but not as severe as previously 

## Levene's test  with multiple independent variables - variance check. more forgiving of departures from normal distribute
library(car)
leveneTest(weight.sqrt ~ condition*pH, data = tri.2017.transformed) # p value is significant. variance across groups is not homogenous. violation of ANOVA assumption
```

```{r Testing ANOVA - Exp Transform}
# exponential transformation using power = 0.24553
tri.2017.exp <- (tri.2017$delta_weight)^(0.24553) 
tri.2017.trans2 <- cbind(tri.2017, tri.2017.exp)
View(tri.2017.trans2)

tri.2017.exp.aov <- aov(tri.2017.exp ~ condition + pH + condition:pH, data = tri.2017.trans2)
summary(tri.2017.exp.aov) # no change in outcome of ANOVA

## Shapiro-Wilk test - normality check
tri2017.transresiduals2 <- residuals(object = tri.2017.exp.aov)
shapiro.test(x = tri2017.transresiduals2) # p value is insignificant. normality is not violated.

# ANOVA assumption: variance across groups are homogeneous
plot(tri.2017.exp.aov, 1) 

## Levene's test  with multiple independent variables
library(car)
leveneTest(tri.2017.exp ~ condition*pH, data = tri.2017.trans2) # p value is significant. variance across groups is not homogenous. violation of ANOVA assumption
```

# Data Import and ANOVA for 2018

```{r 2018 Spagnum_Cyano Import}

library(tidyverse)

tri.2018 <- read.csv("~/Documents/Git/tripartite_symbiosis_paper/fallax_cyano_symbiosis_colleen_10_01_2018.csv") %>% mutate(delta_weight = delta_weight_g *1000)
View(tri.2018)
# Note: This is a baanced design. Proceed as normal.

tri.2018 <- tri.2018 %>% 
  select(pH = initial_pH, condition = component_measured, delta_weight) %>%
  filter(condition == "moss_alone" | condition == "cyano_alone" | condition == "Cyanobacteria_moss_symbiosis" | condition =="Cyanobacteria_moss_seperate")
View(tri.2018)
str(tri.2018)

tri.2018$pH <- factor(tri.2018$pH, 
                      levels = c(3.5, 5.5, 8.5), 
                      labels = c("pH_3.5", "pH_5.5", "pH_8.5"))
tri.2018$condition <- factor(tri.2018$condition, 
                             levels =c("moss_alone", "cyano_alone", "Cyanobacteria_moss_symbiosis", "Cyanobacteria_moss_seperate"), 
                             labels = c("moss_alone", "cyano_alone", "Cyanobacteria_moss_symbiosis", "Cyanobacteria_moss_seperate"))
str(tri.2018)

table(tri.2018$pH, tri.2018$condition) 
```

```{r 2018 Summary statistics and graphs}

tri.2018.sum <- tri.2018 %>% 
  group_by(pH, condition) %>%
  summarise(
    count = n(),
    mean = mean(delta_weight, na.rm = TRUE),
    sd = sd(delta_weight, na.rm = TRUE)
  ) %>% 
  arrange(condition, pH)
View(tri.2018.sum)

ggplot(data = tri.2018.sum, aes(x = pH, y = mean, colour = condition)) + geom_point()
#shows that at pH 5.5+, that cyano_moss symbiosis is higher, suggesting a symbiotic relationship

# recreating Fig. 1
ggplot(data = tri.2018, aes(x = condition, y = delta_weight, colour = condition)) + geom_boxplot() + geom_point()

# recreating Fig. 2
ggplot(data = tri.2018, aes(x = condition, y = delta_weight, colour = condition)) + geom_boxplot() + geom_point() + facet_grid(. ~ pH)

# recreating Fig 3
ggplot(data = tri.2018, aes(x = pH, y = delta_weight)) + geom_boxplot() + geom_point()
```

Data suggests that growth is driven by both condition and pH and that condition influences responses to pH. Graphs show support for the idea that at higher pH there is increased growth of Sphagnum, indicative of a symbiotic relationship. 

```{r 2018 Two-way ANOVA}
# factors: condition * pH
tri.2018.aov <- aov(delta_weight ~ condition + pH + condition:pH, data = tri.2018)
summary(tri.2018.aov) # assumes factors are independent. same outcome as above. 

# Both condition and pH are significant in controlling growth, with pH being the most significant variable. The sigifnicant interaction term suggests that growth is dependent on how condition is influenced by pH

# TukeyHSD
TukeyHSD(tri.2018.aov, which = c("condition", "pH")) # indicates that cyano_moss separate & cyano_moss symbiosis are not significant. What drives the significant anova appears to be differences from cyano_alone, consistent with 2018 data

```

Main question is if cyano_alone and moss_alone grew at different rate than cyano_moss_symbiosis. Graphs show that cyano_moss_symbiosis grows more at high pH, but Tukey HSD suggests that at p-value < 0.05, cyano_moss_symbiosis is only significantly different from cyano_alone and that cyano_moss_separated is different from cyano_alone. This suggests that cyano grows better when in contact or proximity with moss. cyano_moss_separate is nearly significantly different from moss alone (p-value = 0.09 at p-value < 0.1) perhaps indicating that moss benefits marginally from proximity to cyano (hormogonia?), but not as much as cyano benefits from proximity of moss. 

```{r 2018 Two-way ANOVA - Dave }
# double checking that we get same values
# confirmed. anovas match.
dat1 <- read_csv("~/Documents/Git/tripartite_symbiosis_paper/fallax_cyano_symbiosis_colleen_10_01_2018.csv") %>% mutate(delta_weight = delta_weight_g *1000)
View(dat1)

dat.2018 <- dat1 %>% 
  filter(component_measured == "moss_alone" | component_measured == "cyano_alone" | component_measured == "Cyanobacteria_moss_symbiosis" | component_measured =="Cyanobacteria_moss_seperate") %>%
  select(condition = component_measured, pH = initial_pH, delta_weight) %>%
  mutate(condition = paste0(condition, "_2018"))
View(dat.2018)

dat.2018$pH<-factor(dat.2018$pH, levels =c(3.5, 5.5, 8.5), labels = c("pH_3.5", "pH_5.5", "pH_8.5"))
dat.2018$condition<-factor(dat.2018$condition, levels =c("moss_alone_2018", "cyano_alone_2018", "Cyanobacteria_moss_symbiosis_2018", "Cyanobacteria_moss_seperate_2018"), labels = c("moss_alone_2018", "cyano_alone_2018", "Cyanobacteria_moss_symbiosis_2018", "Cyanobacteria_moss_seperate_2018"))
str(dat.2018)

dat.2018.aov2 <- aov(delta_weight ~ condition + pH + condition:pH, data = dat.2018)
summary(dat.2018.aov2)
```

```{r 2018 Testing ANOVA assumptions}

# ANOVA assumption: data is normally distributed
plot(tri.2018.aov, 2)

## Shapiro-Wilk test - normality check
tri2018.residuals <- residuals(object = tri.2018.aov)
shapiro.test(x = tri2018.residuals) # p value not significant. normality is not violated

# ANOVA assumption: variance across groups are homogeneous
# residuals versus fit plot.
plot(tri.2018.aov, 1) # no relationship. no violation

## Bartlett's test with multiple independent variables - variance check 
## need to use interaction() otherwise wrong degrees of freedom = wrong p-value
bartlett.test(delta_weight ~ interaction(condition,pH), data = tri.2018) # not significant. no violation of assumption

## Levene's test  with multiple independent variables - variance check.
library(car)
leveneTest(delta_weight ~ condition*pH, data = tri.2018) # p value not significant. variance across groups is homogenous. no violation of ANOVA assumption
# http://www.sthda.com/english/wiki/compare-multiple-sample-variances-in-r
```

# Comparison 2017 & 2018 - not started yet