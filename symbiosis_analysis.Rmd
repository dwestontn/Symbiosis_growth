---
title: "Tripartite_analysis_manuscript"
author: "Analysis - David J. Weston<br/>Experimentation - Colleen Husley & Megan Gable"
date: "11/16/2018"
output:
  html_document:
    fig_caption: yes
    number_sections: yes
    theme: readable
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}

library(captioner)
library(knitr)
fig_nums <- captioner(prefix = "Fig.")
fig.1_cap <- fig_nums(name = "fig_1", 
                        caption = "2018 data, change in growth (initial weight (wt) - final wt among the two symbiotic partners alone and when added togather but grown seperately (_seperate) and when grown together in same well (_symbiosis). Cyano in symbiosis includes, endophytes, epiphytes and free living cyano.  Data incuded all pH conditions")
fig.2_cap <- fig_nums(name = "fig_2", 
                        caption = "2018 data, change in growth among interacting partners faceted by starting pH condiiton. Measured components as described in fig. 1")
fig.3_cap <- fig_nums(name = "fig_3", 
                        caption = "2018 data, total well biomass change from experiment start to finish. Includes moss + cyano endophyte and free living cyanobacteria not attached to plant")

fig.4_cap <- fig_nums(name = "fig_4", 
                        caption = "2018 data, change in pH change as measured by (final - initial values)")

fig.5_cap <- fig_nums(name = "fig_5", 
                        caption = "2018 data, absolute value of pH change as measured by (final - initial values)")
fig.6_cap <- fig_nums(name = "fig_6", 
                        caption = "2017 data, change in growth (initial weight (wt) - final wt among the two symbiotic partners alone, when added togather but grown seperately (_seperate) and when grown together in same well (_symbiosis). Conditions aggregated over pH") 
fig.7_cap <- fig_nums(name = "fig_7", 
                        caption = "2017 data, change in growth (initial weight (wt) - final wt among the two symbiotic partners alone, when added togather but grown seperately (_seperate) and when grown together in same well (_symbiosis). Similar to Fig. 6 except faceted by pH")
fig.8_cap <- fig_nums(name = "fig_8", 
                        caption = "Combined 2018 and 2017 data for change in growth (initial weight (wt) - among the two symbiotic partners alone, when added togather but grown seperately (_seperate) and when grown together in same well (_symbiosis). Data is faceted by pH")


```


#Growth Analysis for Moss and Cyanobacteria
## Introduction
The symbiosis between Sphagnum mosses and cyanobacteria has long been recognized (Limpricht, 1890) and has been implicated in improved moss growth. This together with evidence form other plant - cyanobacteria symbioses suggest that this is not just a symbiosis (interacting species), but perhaps a mutualsitc interaction -- thereby benefiting both interacting speices. To investigate this further, Colleen Hulsey and Megan Gable conducted a numer of experiments to investigate the growth consequences of cyanobacteria and sphagnum symbiosis on growth patterns at differing pH. conditions.   

### Growth 2018 symbiosis approach and measurements

*Experimental conditions & design
  +conducted on 08/09/2018
  +plants pH nitrogen depleted for 2 weeks prior to start
  +experiment ran for 2 weeks
  +condition 1: Nitrogen (N), 6 replicates -N, 2 replicates for low N (5mL/L NaNO3-- Mm?)
  +Condition 2: pH, 3.5, 5.5, 8.5
  +speices: Sphagnum fallax MN alone, Nostoc muscorum 1037 alone, both species together
  +amounts: 1 moss capitulum, 0.1g cyanobacteria
  +3 - 12 well plates, 2 ml liquid medium per well. 
  
*Measurements
  +fluorcam: area_mm2, QY_max (initial, weekly, final)
  +pH initial, pH weekly, pH final
  +weight beginning and end after water removed with centrifugation

*tests
  +simple scatter and boxplots to view realtionship


### Growth 2018 data import and summary

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
#knitr by default will set the working directory to the source file location
#setwd("~/Documents/Manuscripts:data/Symbiosis_study_2018")
dat1 <- read_csv("fallax_cyano_symbiosis_colleen_10_01_2018.csv") %>% mutate(delta_weight = delta_weight_g *1000)
names(dat1)
summary(dat1)
dim(dat1)

```

### Growth 2018 data boxplot analysis
  1. Delta growth (weight) by organism regardless of pH; 2. Delta growth by organism and by pH; 3. Delta growth for entier wel by pH
  
```{r, echo=FALSE, fig.width = 15, fig.height=10, fig.align='center',fig.cap = fig.1_cap}

ggplot(dat1, aes(color = component_measured,y= delta_weight, x= component_measured)) +
  geom_boxplot(position=position_dodge(.8)) +
  geom_jitter(position=position_dodge(.8)) +
  theme(axis.text=element_text(size=12),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.title=element_text(size=16,face="bold"),
        legend.text=element_text(size=16))

```


```{r, echo=FALSE, fig.width = 15, fig.height=10, fig.align='center',fig.cap = fig.2_cap}

t<-ggplot(dat1, aes(color = component_measured, y= delta_weight, x= component_measured)) +
  geom_boxplot(position=position_dodge(.8)) +
  geom_jitter(position=position_dodge(.8)) +
  theme(axis.text=element_text(size=12),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.title=element_text(size=16,face="bold"),
        legend.text=element_text(size=16))
t+facet_grid(.~initial_pH)

```


```{r, echo=FALSE, fig.width = 15, fig.height=10, fig.align='center',fig.cap = fig.3_cap}

dat.well<-dat1 %>% filter(component_measured == "Cyanobacteria_moss_symbiosis")
t<-ggplot(dat.well, aes(y= delta_weight, x= component_measured)) +
  geom_boxplot(position=position_dodge(.8)) +
  geom_jitter(position=position_dodge(.8)) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        legend.text=element_text(size=16))
t+facet_grid(.~initial_pH)

```


```{r, echo=FALSE, fig.width = 15, fig.height=10, fig.align='center',fig.cap = fig.4_cap}

dat.ph.change<-dat1 %>% mutate(pH_change = final_pH - initial_pH)

t<-ggplot(dat.ph.change, aes(color = component_measured, y= pH_change, x= component_measured)) +
  geom_boxplot(position=position_dodge(.8)) +
  geom_jitter(position=position_dodge(.8)) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.text=element_text(size=16))
t+facet_grid(.~initial_pH)



```



```{r, echo=FALSE, fig.width = 15, fig.height=10, fig.align='center',fig.cap = fig.5_cap}
dat.ph.abs.change<-dat1 %>% mutate(abs_pH_change = abs(final_pH - initial_pH))

t<-ggplot(dat.ph.abs.change, aes(color = component_measured, y= abs_pH_change, x= component_measured)) +
  geom_boxplot(position=position_dodge(.8)) +
  geom_jitter(position=position_dodge(.8)) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.text=element_text(size=16))
t+facet_grid(.~initial_pH)

```


## Growth 2017 symbiosis approach and measurements

need experimental details here...





### Growth 2017 data import and summary

```{r, warning = FALSE, message = FALSE}

dat2 <- read_csv("fallax_cyano_symbiosis_allyssa_colleen_2017.csv")
dat3 <- dat2 %>% filter(pH == 3.5 | pH == 5.5 | pH == 8.5)
names(dat3)
summary(dat3)
dim(dat3)

```


### Boxplot analysis of 2017 data

```{r, echo=FALSE, fig.width = 15, fig.height=10, fig.align='center',fig.cap = fig.6_cap}

ggplot(dat3, aes(color = condition,y= delta_weight, x= condition)) +
  geom_boxplot(position=position_dodge(.8)) +
  geom_jitter(position=position_dodge(.8)) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        legend.text=element_text(size=16))


```


```{r, echo=FALSE, fig.width = 15, fig.height=10, fig.align='center',fig.cap = fig.7_cap}

t<-ggplot(dat3, aes(color = condition,y= delta_weight, x= condition)) +
  geom_boxplot(position=position_dodge(.8)) +
  geom_jitter(position=position_dodge(.8)) +
  theme(axis.text=element_text(size=12),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.title=element_text(size=16,face="bold"),
        legend.text=element_text(size=16))
t+facet_grid(.~pH)

```




```{r, echo=FALSE, fig.width = 15, fig.height=10, fig.align='center',fig.cap = fig.8_cap}

dat.2018 <- dat1 %>% filter(component_measured == "moss_alone" | component_measured == "cyano_alone" | component_measured == "Cyanobacteria_moss_symbiosis" |
                              component_measured =="Cyanobacteria_moss_seperate") %>%
  select(condition = component_measured, pH = initial_pH, delta_weight) %>%
  mutate(condition = paste0(condition, "_2018"))

dat.2017 <- dat3 %>% select(condition, pH, delta_weight) %>%
  mutate(condition = paste0(condition, "_2017"))

dat.combined<-rbind(dat.2018, dat.2017)


t<-ggplot(dat.combined, aes(color = condition,y= delta_weight, x= condition)) +
  geom_boxplot(position=position_dodge(.8)) +
  geom_jitter(position=position_dodge(.8)) +
  theme(axis.text=element_text(size=12),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.title=element_text(size=16,face="bold"),
        legend.text=element_text(size=16))
t+facet_grid(.~pH)



```


### ANOVA analysis of 2017

Specifically testing if cyano and moss grown alone, increased in growth at a different rate than when grown together in smbiosis.

```{r 2017 Sphagnum-Cyano Import}
library(tidyverse)

tri.2017 <- read.csv("~/Documents/Git/tripartite_symbiosis_paper/fallax_cyano_symbiosis_allyssa_colleen_2017.csv")
View(tri.2017)

tri.2017 <- tri.2017 %>% 
  select(pH = pH, condition = condition, delta_weight) %>%
  filter(pH == "3.5" | pH == "5.5" | pH == "8.5") %>% 
  filter(condition == "moss_alone" | condition == "cyano_alone" | condition == "Cyanobacteria_moss_symbiosis" | condition =="Cyanobacteria_moss_seperate")
View(tri.2017)
str(tri.2017)

tri.2017$pH <- factor(tri.2017$pH, 
                      levels = c(3.5, 5.5, 8.5), 
                      labels = c("pH_3.5", "pH_5.5", "pH_8.5"))

table(tri.2017$pH, tri.2017$condition) # balanced design
```

```{r 2017 Summary statistics and graphs}

tri.2017.sum <- tri.2017 %>% 
  group_by(pH, condition) %>%
  summarise(
    count = n(),
    mean = mean(delta_weight, na.rm = TRUE),
    sd = sd(delta_weight, na.rm = TRUE)
  ) %>% 
  arrange(condition, pH)
View(tri.2017.sum)

# double checking figures in Dave's notebook
ggplot(data = tri.2017.sum, aes(x = pH, y = mean, colour = condition)) + geom_point()
#shows that at all pH cyano_moss symbiosis is higher, suggesting a symbiotic relationship

# recreating Fig. 1
ggplot(data = tri.2017, aes(x = condition, y = delta_weight, colour = condition)) + geom_boxplot() + geom_point()

# recreating Fig. 2
ggplot(data = tri.2017, aes(x = condition, y = delta_weight, colour = condition)) + geom_boxplot() + geom_point() + facet_grid(. ~ pH)

# recreating Fig 3
ggplot(data = tri.2017, aes(x = pH, y = delta_weight)) + geom_boxplot() + geom_point()
```

Confirms similar info to 2018 data. Cyano & moss grown together have higher weight than grown separate or grown alone. Higher pHs correspond to produce higher growth with the symbiotic relationship increasing growth response as pH increases. 

```{r 2017 Two-way ANOVA}
# factors: condition * pH
tri.2017.aov <- aov(delta_weight ~ condition + pH + condition:pH, data = tri.2017)
summary(tri.2017.aov) # assumes factors are independent. same outcome as above. 

# Both condition and pH are significant in controlling growth, with condition being the most significant variable.the interaction term is not significant suggesting that pH and condition influence growth independently of each other

TukeyHSD(tri.2017.aov, which = c("condition", "pH")) 
# indicates that cyano_moss separate & cyano_moss symbiosis is nearly significant (p-value = 0.077). What drives the significant ANOVA appears to be the differences between cyano_moss_symbiosis and cyano_alone as well as the differences between cyano_moss_symbiosis and moss-alone. This confirms that grown together is more beneficial than grown apart and that being in proximity approximates being in contact (also better than being grown apart).
```

```{r 2017 Testing ANOVA assumptions}
# ANOVA assumption: data is normally distributed
plot(tri.2017.aov, 2)

## Shapiro-Wilk test - normality check
tri2017.residuals <- residuals(object = tri.2017.aov)
shapiro.test(x = tri2017.residuals) # p value is significant. normality is violated. data will need to be transformed.

# ANOVA assumption: variance across groups are homogeneous
plot(tri.2017.aov, 1) # funnel indicative of violation of homogeneous variance

## cannot use Bartlett's test for variance check because normality is violated

## Levene's test (more forgiving of departures from normal distribution)
library(car)
leveneTest(delta_weight ~ condition*pH, data = tri.2017) # p value is significant. variance across groups is not homogenous. 
```

```{r 2017 Nonparametric Tests}
# heteroscedasticity-corrected coefficient covariance matrix
library(car)
tri.2017.aovadjust <- Anova(tri.2017.aov, white.adjust = TRUE)

# Scheirer Ray Hare test
library(rcompanion)
tri.2017.srh <- scheirerRayHare(delta_weight ~ condition + pH, data = tri.2017)

```

#### 2017 Data Transformations 
```{r 2017 Normality and Variance correction}
# delta_weight untransformed
weight <- tri.2017$delta_weight
View(weight)

hist(tri.2017$delta_weight)
qqnorm(weight)
qqline(weight, col = "red")
# positively skewed options: square root, cube root, and log

# square root transform
weight.sqrt <- sqrt(weight) # NAs produced bc negative numbers
hist(weight.sqrt)
qqnorm(weight.sqrt)
qqline(weight.sqrt, col = "red")

# include cube root just for comparison
weight.cubed <- sign(weight) * abs(weight)^(1/3)
hist(weight.cubed)
qqnorm(weight.cubed)
qqline(weight.cubed, col = "red")

# log transformation is more commonly used for size data
weight.log <- weight + 22.33 # attempting to make all values positive without changing relative differences
weight.log <- log10(weight.log)
View(weight.log)

hist(weight.log)
qqnorm(weight.log)
qqline(weight.log, col = "red")

# exponential transformation 
means <- aggregate(tri.2017$delta_weight, list(tri.2017$pH), mean)
vars <- aggregate(tri.2017$delta_weight, list(tri.2017$pH), var)

logmeans <- log10(means$x)
logvars <- log10(vars$x)

weight_mod <- lm(logvars ~ logmeans)
summary(weight_mod) # slope = 1.508940

# power = 1 - (b/2)
1 - (1.508940/2) # 0.24553
```

```{r 2017 Testing ANOVA - Square root}
# square root transformation

tri.2017.transformed <- cbind(tri.2017, weight.sqrt)
View(tri.2017.transformed)

tri.2017.trans.aov <- aov(weight.sqrt ~ condition + pH + condition:pH, data = tri.2017.transformed)
summary(tri.2017.trans.aov) # no change in outcome of ANOVA

## Shapiro-Wilk test - normality check
tri2017.transresiduals <- residuals(object = tri.2017.trans.aov)
shapiro.test(x = tri2017.transresiduals) # p value is insignificant. normality is not violated.

# ANOVA assumption: variance across groups are homogeneous
plot(tri.2017.trans.aov, 1) # slight funnel, but not as severe as previously 

## Levene's test  with multiple independent variables - variance check. more forgiving of departures from normal distribute
library(car)
leveneTest(weight.sqrt ~ condition*pH, data = tri.2017.transformed) # p value is significant. variance across groups is not homogenous. violation of ANOVA assumption
```

```{r Testing ANOVA - Exp Transform}
# exponential transformation using power = 0.24553
tri.2017.exp <- (tri.2017$delta_weight)^(0.24553) 
tri.2017.trans2 <- cbind(tri.2017, tri.2017.exp)
View(tri.2017.trans2)

tri.2017.exp.aov <- aov(tri.2017.exp ~ condition + pH + condition:pH, data = tri.2017.trans2)
summary(tri.2017.exp.aov) # no change in outcome of ANOVA

## Shapiro-Wilk test - normality check
tri2017.transresiduals2 <- residuals(object = tri.2017.exp.aov)
shapiro.test(x = tri2017.transresiduals2) # p value is insignificant. normality is not violated.

# ANOVA assumption: variance across groups are homogeneous
plot(tri.2017.exp.aov, 1) 

## Levene's test  with multiple independent variables
library(car)
leveneTest(tri.2017.exp ~ condition*pH, data = tri.2017.trans2) # p value is significant. variance across groups is not homogenous. violation of ANOVA assumption
```

### ANOVA analysis of 2018

```{r 2018 Spagnum_Cyano Import}

library(tidyverse)

tri.2018 <- read.csv("~/Documents/Git/tripartite_symbiosis_paper/fallax_cyano_symbiosis_colleen_10_01_2018.csv") %>% mutate(delta_weight = delta_weight_g *1000)
View(tri.2018)
# Note: This is a baanced design. Proceed as normal.

tri.2018 <- tri.2018 %>% 
  select(pH = initial_pH, condition = component_measured, delta_weight) %>%
  filter(condition == "moss_alone" | condition == "cyano_alone" | condition == "Cyanobacteria_moss_symbiosis" | condition =="Cyanobacteria_moss_seperate")
View(tri.2018)
str(tri.2018)

tri.2018$pH <- factor(tri.2018$pH, 
                      levels = c(3.5, 5.5, 8.5), 
                      labels = c("pH_3.5", "pH_5.5", "pH_8.5"))
tri.2018$condition <- factor(tri.2018$condition, 
                             levels =c("moss_alone", "cyano_alone", "Cyanobacteria_moss_symbiosis", "Cyanobacteria_moss_seperate"), 
                             labels = c("moss_alone", "cyano_alone", "Cyanobacteria_moss_symbiosis", "Cyanobacteria_moss_seperate"))
str(tri.2018)

table(tri.2018$pH, tri.2018$condition) 
```

```{r 2018 Summary statistics and graphs}

tri.2018.sum <- tri.2018 %>% 
  group_by(pH, condition) %>%
  summarise(
    count = n(),
    mean = mean(delta_weight, na.rm = TRUE),
    sd = sd(delta_weight, na.rm = TRUE)
  ) %>% 
  arrange(condition, pH)
View(tri.2018.sum)

ggplot(data = tri.2018.sum, aes(x = pH, y = mean, colour = condition)) + geom_point()
#shows that at pH 5.5+, that cyano_moss symbiosis is higher, suggesting a symbiotic relationship

# recreating Fig. 1
ggplot(data = tri.2018, aes(x = condition, y = delta_weight, colour = condition)) + geom_boxplot() + geom_point()

# recreating Fig. 2
ggplot(data = tri.2018, aes(x = condition, y = delta_weight, colour = condition)) + geom_boxplot() + geom_point() + facet_grid(. ~ pH)

# recreating Fig 3
ggplot(data = tri.2018, aes(x = pH, y = delta_weight)) + geom_boxplot() + geom_point()
```

Data suggests that growth is driven by both condition and pH and that condition influences responses to pH. Graphs show support for the idea that at higher pH there is increased growth of Sphagnum, indicative of a symbiotic relationship. 

```{r 2018 Two-way ANOVA}
# factors: condition * pH
tri.2018.aov <- aov(delta_weight ~ condition + pH + condition:pH, data = tri.2018)
summary(tri.2018.aov) # assumes factors are independent. same outcome as above. 

# Both condition and pH are significant in controlling growth, with pH being the most significant variable. The sigifnicant interaction term suggests that growth is dependent on how condition is influenced by pH

# TukeyHSD
TukeyHSD(tri.2018.aov, which = c("condition", "pH")) # indicates that cyano_moss separate & cyano_moss symbiosis are not significant. What drives the significant anova appears to be differences from cyano_alone, consistent with 2018 data

```

Main question is if cyano_alone and moss_alone grew at different rate than cyano_moss_symbiosis. Graphs show that cyano_moss_symbiosis grows more at high pH, but Tukey HSD suggests that at p-value < 0.05, cyano_moss_symbiosis is only significantly different from cyano_alone and that cyano_moss_separated is different from cyano_alone. This suggests that cyano grows better when in contact or proximity with moss. cyano_moss_separate is nearly significantly different from moss alone (p-value = 0.09 at p-value < 0.1) perhaps indicating that moss benefits marginally from proximity to cyano (hormogonia?), but not as much as cyano benefits from proximity of moss. 

```{r 2018 Testing ANOVA assumptions}

# ANOVA assumption: data is normally distributed
plot(tri.2018.aov, 2)

## Shapiro-Wilk test - normality check
tri2018.residuals <- residuals(object = tri.2018.aov)
shapiro.test(x = tri2018.residuals) # p value not significant. normality is not violated

# ANOVA assumption: variance across groups are homogeneous
# residuals versus fit plot.
plot(tri.2018.aov, 1) # no relationship. no violation

## Bartlett's test with multiple independent variables - variance check 
## need to use interaction() otherwise wrong degrees of freedom = wrong p-value
bartlett.test(delta_weight ~ interaction(condition,pH), data = tri.2018) # not significant. no violation of assumption

## Levene's test  with multiple independent variables - variance check.
library(car)
leveneTest(delta_weight ~ condition*pH, data = tri.2018) # p value not significant. variance across groups is homogenous. no violation of ANOVA assumption
# http://www.sthda.com/english/wiki/compare-multiple-sample-variances-in-r
```

### Comparison 2017 & 2018
```{r All Data Summary Stats}
# Creating giant dataset
year <- rep("2017", length(tri.2017$pH))
tri.2017 <- cbind(year, tri.2017)

year <- rep("2018", length(tri.2018$pH))
tri.2018 <- cbind(year, tri.2018)

alldata <- rbind(tri.2017, tri.2018)
View(alldata)

# Summary Stats
alldata.sum <- alldata %>% 
  group_by(year, pH, condition) %>% 
   summarise(
    count = n(),
    mean = mean(delta_weight, na.rm = TRUE),
    sd = sd(delta_weight, na.rm = TRUE)
  )

View(alldata.sum)
```

```{r ANOVAs with factor(year)}
year.condition <- aov(delta_weight ~ year + condition + year:condition, data = alldata)
summary(year.condition)
TukeyHSD(year.condition, which = c("year", "condition"))

year.ph <- aov(delta_weight ~ year + pH + year:pH, data = alldata)
summary(year.ph)

year <- aov(delta_weight ~ year, data = alldata) # year is not significant
summary(year)
```

```{r pH 3.5 t-tests}
# in lieue of two-way repeated meaasures ANOVA
#  condition = cyano_alone
ph3.5_cyano_alone_2017 <- tri.2017 %>% 
  filter(pH == "pH_3.5") %>% 
  filter(condition == "cyano_alone")
View(ph3.5_cyano_alone_2017)

ph3.5_cyano_alone_2018 <- tri.2018 %>%
  filter(pH == "pH_3.5") %>% 
  filter(condition == "cyano_alone")
View(ph3.5_cyano_alone_2018)

t.test(ph3.5_cyano_alone_2017$delta_weight, ph3.5_cyano_alone_2018$delta_weight) # not significant

# condition = moss_alone
ph3.5_moss_alone_2017 <- tri.2017 %>% 
  filter(pH == "pH_3.5") %>% 
  filter(condition == "moss_alone")
View(ph3.5_moss_alone_2017)

ph3.5_moss_alone_2018 <- tri.2018 %>%
  filter(pH == "pH_3.5") %>% 
  filter(condition == "moss_alone")
View(ph3.5_moss_alone_2018)

t.test(ph3.5_moss_alone_2017$delta_weight, ph3.5_moss_alone_2018$delta_weight) # not significant

# condition = Cyanobacteria_moss_seperate
ph3.5_cmseparate_2017 <- tri.2017 %>% 
  filter(pH == "pH_3.5") %>% 
  filter(condition == "Cyanobacteria_moss_seperate")
View(ph3.5_cmseparate_2017)

ph3.5_cmseparate_2018 <- tri.2018 %>%
  filter(pH == "pH_3.5") %>% 
  filter(condition == "Cyanobacteria_moss_seperate")
View(ph3.5_cmseparate_2018)

t.test(ph3.5_cmseparate_2017$delta_weight, ph3.5_cmseparate_2018$delta_weight) # not significant

# condition = Cyanobacteria_moss_symbiosis
ph3.5_cmsymbiosis_2017 <- tri.2017 %>% 
  filter(pH == "pH_3.5") %>% 
  filter(condition == "Cyanobacteria_moss_symbiosis")
View(ph3.5_cmsymbiosis_2017)

ph3.5_cmsymbiosis_2018 <- tri.2018 %>%
  filter(pH == "pH_3.5") %>% 
  filter(condition == "Cyanobacteria_moss_symbiosis")
View(ph3.5_cmsymbiosis_2018)

t.test(ph3.5_cmsymbiosis_2017$delta_weight, ph3.5_cmsymbiosis_2018$delta_weight) # p-value = 0.06835
```


```{r pH 5.5 t-tests}
#  condition = cyano_alone
ph5.5_cyano_alone_2017 <- tri.2017 %>% 
  filter(pH == "pH_5.5") %>% 
  filter(condition == "cyano_alone")
View(ph5.5_cyano_alone_2017)

ph5.5_cyano_alone_2018 <- tri.2018 %>%
  filter(pH == "pH_5.5") %>% 
  filter(condition == "cyano_alone")
View(ph5.5_cyano_alone_2018)

t.test(ph5.5_cyano_alone_2017$delta_weight, ph5.5_cyano_alone_2018$delta_weight) # not significant

# condition = moss_alone
ph5.5_moss_alone_2017 <- tri.2017 %>% 
  filter(pH == "pH_5.5") %>% 
  filter(condition == "moss_alone")
View(ph5.5_moss_alone_2017)

ph5.5_moss_alone_2018 <- tri.2018 %>%
  filter(pH == "pH_5.5") %>% 
  filter(condition == "moss_alone")
View(ph5.5_moss_alone_2018)

t.test(ph5.5_moss_alone_2017$delta_weight, ph5.5_moss_alone_2018$delta_weight) # not significant

# condition = Cyanobacteria_moss_seperate
ph5.5_cmseparate_2017 <- tri.2017 %>% 
  filter(pH == "pH_5.5") %>% 
  filter(condition == "Cyanobacteria_moss_seperate")
View(ph5.5_cmseparate_2017)

ph5.5_cmseparate_2018 <- tri.2018 %>%
  filter(pH == "pH_5.5") %>% 
  filter(condition == "Cyanobacteria_moss_seperate")
View(ph5.5_cmseparate_2018)

t.test(ph5.5_cmseparate_2017$delta_weight, ph5.5_cmseparate_2018$delta_weight) # not significant

# condition = Cyanobacteria_moss_symbiosis
ph5.5_cmsymbiosis_2017 <- tri.2017 %>% 
  filter(pH == "pH_5.5") %>% 
  filter(condition == "Cyanobacteria_moss_symbiosis")
View(ph5.5_cmsymbiosis_2017)

ph5.5_cmsymbiosis_2018 <- tri.2018 %>%
  filter(pH == "pH_5.5") %>% 
  filter(condition == "Cyanobacteria_moss_symbiosis")
View(ph5.5_cmsymbiosis_2018)

t.test(ph5.5_cmsymbiosis_2017$delta_weight, ph5.5_cmsymbiosis_2018$delta_weight) # not significant
```

```{r pH 8.5 t-tests}
#  condition = cyano_alone
ph8.5_cyano_alone_2017 <- tri.2017 %>% 
  filter(pH == "pH_8.5") %>% 
  filter(condition == "cyano_alone")
View(ph8.5_cyano_alone_2017)

ph8.5_cyano_alone_2018 <- tri.2018 %>%
  filter(pH == "pH_8.5") %>% 
  filter(condition == "cyano_alone")
View(ph8.5_cyano_alone_2018)

t.test(ph8.5_cyano_alone_2017$delta_weight, ph8.5_cyano_alone_2018$delta_weight) # not significant

# condition = moss_alone
ph8.5_moss_alone_2017 <- tri.2017 %>% 
  filter(pH == "pH_8.5") %>% 
  filter(condition == "moss_alone")
View(ph8.5_moss_alone_2017)

ph8.5_moss_alone_2018 <- tri.2018 %>%
  filter(pH == "pH_8.5") %>% 
  filter(condition == "moss_alone")
View(ph8.5_moss_alone_2018)

t.test(ph8.5_moss_alone_2017$delta_weight, ph8.5_moss_alone_2018$delta_weight) # not significant

# condition = Cyanobacteria_moss_seperate
ph8.5_cmseparate_2017 <- tri.2017 %>% 
  filter(pH == "pH_8.5") %>% 
  filter(condition == "Cyanobacteria_moss_seperate")
View(ph8.5_cmseparate_2017)

ph8.5_cmseparate_2018 <- tri.2018 %>%
  filter(pH == "pH_8.5") %>% 
  filter(condition == "Cyanobacteria_moss_seperate")
View(ph8.5_cmseparate_2018)

t.test(ph8.5_cmseparate_2017$delta_weight, ph8.5_cmseparate_2018$delta_weight) # not significant

# condition = Cyanobacteria_moss_symbiosis
ph8.5_cmsymbiosis_2017 <- tri.2017 %>% 
  filter(pH == "pH_8.5") %>% 
  filter(condition == "Cyanobacteria_moss_symbiosis")
View(ph8.5_cmsymbiosis_2017)

ph8.5_cmsymbiosis_2018 <- tri.2018 %>%
  filter(pH == "pH_8.5") %>% 
  filter(condition == "Cyanobacteria_moss_symbiosis")
View(ph8.5_cmsymbiosis_2018)

t.test(ph8.5_cmsymbiosis_2017$delta_weight, ph8.5_cmsymbiosis_2018$delta_weight) # p-value = 0.06304
```

```{r 2017 & 2018 Comparison Figure}
# boxplot
tri.boxplot <- ggplot(data = alldata, aes(x = condition, y = delta_weight, fill = year)) + geom_boxplot(colour = "black") + 
  geom_point(aes(x = condition), pch = 21, position = position_jitterdodge()) + 
  scale_x_discrete(limits=c("cyano_alone", "moss_alone", "Cyanobacteria_moss_seperate", "Cyanobacteria_moss_symbiosis")) + 
  facet_grid(. ~ pH) + 
  theme_bw() + theme(legend.position = c(0.07, 0.9)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(axis.title.x = element_blank()) +
  ylab(expression(Delta~weight~(g))) + 
  scale_y_continuous(breaks = seq(-50, 200, 25)) + scale_fill_grey(start = 0.8, end = 0.2) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

pdf("tri_boxplot.pdf")
plot(tri.boxplot)
dev.off()

# means
means.plot <- ggplot(data = alldata.sum, aes(x = condition, y = mean, colour = year)) + facet_grid(. ~ pH) + geom_pointrange(aes(ymin = mean-sd, ymax = mean+sd), position = position_dodge(0.5)) + 
  scale_x_discrete(limits=c("cyano_alone", "moss_alone", "Cyanobacteria_moss_seperate", "Cyanobacteria_moss_symbiosis")) + 
  facet_grid(. ~ pH) + 
  theme_bw() + theme(legend.position = c(0.07, 0.9)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(axis.title.x = element_blank()) +
  ylab(expression(mean ~Delta~weight~(g))) + 
  scale_y_continuous(breaks = seq(-50, 200, 25)) + scale_colour_grey(start = 0.5, end = 0.2) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

pdf("means_plot.pdf")
plot(means.plot)
dev.off()
```

# Metabolite Analysis

##Introduction to design

(in progress)

## metablite change when cyanobacteria pellet is crossfed with moss supernantant

Goal -- determine significant changes in metabolites between cyanobacteria and moss using kruskal wallis test.

To look at how suernatant from 1) cyano pellet when incubated with moss supernatant (Ph2-super-Nmusc-SfallaxSupp) compares to 2) moss only supernantant (Ph1-super-Sfallax).

```{r, echo=FALSE}

library(broom)
met.dat<-read.csv("data_formated_input_06262018.csv")
#met.dat%>%group_by(treat_cond) %>%tally()
#head(met.dat)

a<-met.dat %>% select(treat_cond, JGI_compound_id, peak_ht) %>% filter(treat_cond %in% c("Ph2-super-Nmusc-SfallaxSupp", "Ph1-super-Sfallax"))

#to account for the dillution from phase 1 to phase 2
a<-a %>% mutate(peak_ht = ifelse(treat_cond == "Ph1-super-Sfallax", peak_ht/2, peak_ht * 1))
a$JGI_compound_id <- as.factor(a$JGI_compound_id)
a$treat_cond <- as.factor(a$treat_cond)

b<- a %>% group_by(JGI_compound_id) %>% do(tidy(kruskal.test(x= .$peak_ht, g = .$treat_cond))) %>% select(JGI_compound_id, statistic, p.value)

c <-a %>% filter(treat_cond == "Ph2-super-Nmusc-SfallaxSupp") %>% group_by(JGI_compound_id) %>% mutate(mean_Pelcyano_SupMoss = mean(peak_ht)) %>% select(JGI_compound_id, mean_Pelcyano_SupMoss) %>% unique()

c2 <- a %>% filter(treat_cond == "Ph1-super-Sfallax") %>% group_by(JGI_compound_id) %>% mutate(mean_super_moss = mean(peak_ht)) %>% select(JGI_compound_id, mean_super_moss) %>% unique()

c3 <- left_join(c,c2, by = "JGI_compound_id") %>% mutate(met_direction = ifelse(mean_Pelcyano_SupMoss > mean_super_moss, "eluted_by cyano",  "uptake_up by cyano"))

crossfeed_PelCyano_MossSuper<- met.dat %>% select(JGI_compound_id, compound_atlas_ID, label, Identified_metabolite) %>% unique()

crossfeed_PelCyano_MossSuper$JGI_compound_id <-as.factor(crossfeed_PelCyano_MossSuper$JGI_compound_id)
crossfeed_PelCyano_MossSuper$compound_atlas_ID <-as.factor(crossfeed_PelCyano_MossSuper$compound_atlas_ID)
crossfeed_PelCyano_MossSuper$Identified_metabolite <-as.factor(crossfeed_PelCyano_MossSuper$Identified_metabolite)

crossfeed_PelCyano_MossSuper<-as.data.frame(crossfeed_PelCyano_MossSuper)
c3<-as.data.frame(c3)
crossfeed_PelCyano_MossSuper <- left_join(c3, crossfeed_PelCyano_MossSuper, by = "JGI_compound_id")

crossfeed_PelCyano_MossSuper<-left_join(b, crossfeed_PelCyano_MossSuper, by = "JGI_compound_id")
crossfeed_PelCyano_MossSuper<-crossfeed_PelCyano_MossSuper %>% arrange(p.value)

#output
kable(crossfeed_PelCyano_MossSuper[1:8, c(-1, -2, -4,-5)], caption = "Header- crossfed cyano pellet with moss supernatant")

num_sig_elluted<-nrow(crossfeed_PelCyano_MossSuper %>% filter(p.value <= 0.05 & met_direction == "eluted_by cyano"))
num_sig_uptake<-nrow(crossfeed_PelCyano_MossSuper %>% filter(p.value <= 0.05 & met_direction == "uptake_up by cyano"))

print(paste("# elluted cyanobacteria metabolites (p.value <= 0.05) is:", num_sig_elluted))
print(paste("# taken cyanobacteria metabolites (p.value <= 0.05) is:", num_sig_uptake))

#write_excel_csv(crossfeed_PelCyano_MossSuper, "crossfeed_output_PelCyano_MossSuper_halfstrength.csv")

```

## metablite change when moss pellet is crossfed with cyanobacteria supernantant

Goal -- determine significant changes in metabolites between cyanobacteria and moss using kruskal wallis test.

Supernatant changes from 1) suernatant from moss pellet when incubated with cyanobacteria supernatant (Ph2-super-Sfallax-NmuscSupp) compared to 2) cyanobacteria pellet only supernantant (Ph1-super-Nmusc).


```{r, echo=FALSE}

x<-met.dat %>% select(treat_cond, JGI_compound_id, peak_ht) %>% filter(treat_cond %in% c("Ph2-super-Sfallax-NmuscSupp", "Ph1-super-Nmusc"))

#to account for the dillution from phase 1 to phase 2
x<-x %>% mutate(peak_ht = ifelse(treat_cond == "Ph1-super-Nmusc", peak_ht/2, peak_ht * 1))
x$JGI_compound_id <- as.factor(x$JGI_compound_id)
x$treat_cond <- as.factor(x$treat_cond)
y<- x %>% group_by(JGI_compound_id) %>% do(tidy(kruskal.test(x= .$peak_ht, g = .$treat_cond))) %>% select(JGI_compound_id, statistic, p.value) 
z <-x %>% filter(treat_cond == "Ph2-super-Sfallax-NmuscSupp") %>% group_by(JGI_compound_id) %>% mutate(mean_PelMoss_SupCyano = mean(peak_ht)) %>% select(JGI_compound_id, mean_PelMoss_SupCyano) %>% unique()
z2 <- x %>% filter(treat_cond == "Ph1-super-Nmusc") %>% group_by(JGI_compound_id) %>% mutate(mean_super_cyano = mean(peak_ht)) %>% select(JGI_compound_id, mean_super_cyano) %>% unique()
z3 <- left_join(z,z2, by = "JGI_compound_id") %>% mutate(met_direction = ifelse(mean_PelMoss_SupCyano > mean_super_cyano, "eluted_by moss",  "uptake_up by moss"))


crossfeed_PelMoss_CyanoSuper<- met.dat %>% select(JGI_compound_id, compound_atlas_ID, label, Identified_metabolite) %>% unique()
crossfeed_PelMoss_CyanoSuper$JGI_compound_id <-as.factor(crossfeed_PelMoss_CyanoSuper$JGI_compound_id)
crossfeed_PelMoss_CyanoSuper$compound_atlas_ID <-as.factor(crossfeed_PelMoss_CyanoSuper$compound_atlas_ID)
crossfeed_PelMoss_CyanoSuper$Identified_metabolite <-as.factor(crossfeed_PelMoss_CyanoSuper$Identified_metabolite)

crossfeed_PelMoss_CyanoSuper<-as.data.frame(crossfeed_PelMoss_CyanoSuper)
z3<-as.data.frame(z3)
crossfeed_PelMoss_CyanoSuper <- left_join(z3, crossfeed_PelMoss_CyanoSuper, by = "JGI_compound_id")

crossfeed_PelMoss_CyanoSuper<-left_join(y, crossfeed_PelMoss_CyanoSuper, by = "JGI_compound_id")
crossfeed_PelMoss_CyanoSuper<-crossfeed_PelMoss_CyanoSuper %>% arrange(p.value)

kable(crossfeed_PelMoss_CyanoSuper[1:8, c(-1, -2, -4,-5)], caption = "Header- crossfed moss pellet with cyanobacteria supernatant")

num_sig_elluted<-nrow(crossfeed_PelMoss_CyanoSuper %>% filter(p.value <= 0.05 & met_direction == "eluted_by moss"))
num_sig_uptake<-nrow(crossfeed_PelMoss_CyanoSuper %>% filter(p.value <= 0.05 & met_direction == "uptake_up by moss"))

print(paste("# elluted moss metabolites (p.value <= 0.05) is:", num_sig_elluted))
print(paste("# taken moss metabolites (p.value <= 0.05) is:", num_sig_uptake))

#write_excel_csv(crossfeed_PelMoss_CyanoSuper, "crossfeed_output_PelMoss_CyanoSuper_halfstrength.csv")


```


## metablite change when fungus pellet is crossfed with cyanobacteria supernantant

Goal -- determine significant changes in metabolites between fungus and cyanobacteria using kruskal wallis test.

Supernatant changes from 1) suernatant from fungus pellet when incubated with cyanobacteria supernatant (Ph2-super-Tacro-NmuscSupp) compared to 2) cyanobacteria pellet only supernantant (Ph1-super-Nmusc).


```{r, echo=FALSE}

h<-met.dat %>% select(treat_cond, JGI_compound_id, peak_ht) %>% filter(treat_cond %in% c("Ph2-super-Tacro-NmuscSupp", "Ph1-super-Nmusc"))

#to account for the dillution from phase 1 to phase 2
h<-h %>% mutate(peak_ht = ifelse(treat_cond == "Ph1-super-Sfallax", peak_ht/2, peak_ht * 1))
h$JGI_compound_id <- as.factor(h$JGI_compound_id)
h$treat_cond <- as.factor(h$treat_cond)

#Kruskal Wallis test
i<- h %>% group_by(JGI_compound_id) %>% do(tidy(kruskal.test(x= .$peak_ht, g = .$treat_cond))) %>% select(JGI_compound_id, statistic, p.value)

#datatable creation
j <-h %>% filter(treat_cond == "Ph2-super-Tacro-NmuscSupp") %>% group_by(JGI_compound_id) %>% mutate(mean_Pelfung_SupCyano = mean(peak_ht)) %>% select(JGI_compound_id, mean_Pelfung_SupCyano) %>% unique()

j2 <- h %>% filter(treat_cond == "Ph1-super-Nmusc") %>% group_by(JGI_compound_id) %>% mutate(mean_super_cyano = mean(peak_ht)) %>% select(JGI_compound_id, mean_super_cyano) %>% unique()

j3 <- left_join(j,j2, by = "JGI_compound_id") %>% mutate(met_direction = ifelse(mean_Pelfung_SupCyano > mean_super_cyano, "eluted_by fungus",  "uptake_up by fungus"))

crossfeed_PelFung_CyanoSuper<- met.dat %>% select(JGI_compound_id, compound_atlas_ID, label, Identified_metabolite) %>% unique()

crossfeed_PelFung_CyanoSuper$JGI_compound_id <-as.factor(crossfeed_PelFung_CyanoSuper$JGI_compound_id)
crossfeed_PelFung_CyanoSuper$compound_atlas_ID <-as.factor(crossfeed_PelFung_CyanoSuper$compound_atlas_ID)
crossfeed_PelFung_CyanoSuper$Identified_metabolite <-as.factor(crossfeed_PelFung_CyanoSuper$Identified_metabolite)

crossfeed_PelFung_CyanoSuper<-as.data.frame(crossfeed_PelFung_CyanoSuper)
j3<-as.data.frame(j3)
crossfeed_PelFung_CyanoSuper <- left_join(j3, crossfeed_PelFung_CyanoSuper, by = "JGI_compound_id")

crossfeed_PelFung_CyanoSuper<-left_join(i, crossfeed_PelFung_CyanoSuper, by = "JGI_compound_id")
crossfeed_PelFung_CyanoSuper<-crossfeed_PelFung_CyanoSuper %>% arrange(p.value)

#output
kable(crossfeed_PelFung_CyanoSuper[1:8, c(-1, -2, -4,-5)], caption = "Header- crossfed fungus pellet with cyano supernatant")

num_sig_elluted<-nrow(crossfeed_PelFung_CyanoSuper %>% filter(p.value <= 0.05 & met_direction == "eluted_by fungus"))
num_sig_uptake<-nrow(crossfeed_PelFung_CyanoSuper %>% filter(p.value <= 0.05 & met_direction == "uptake_up by fungus"))

print(paste("# elluted fungal metabolites (p.value <= 0.05) is:", num_sig_elluted))
print(paste("# taken fungal metabolites (p.value <= 0.05) is:", num_sig_uptake))

#write_excel_csv(crossfeed_PelFung_CyanoSuper, "crossfeed_output_PelFung_CyanoSuper_halfstrength.csv")

```



## metablite change when fungus pellet is crossfed with moss supernantant

Goal -- determine significant changes in metabolites between fungus and moss using kruskal wallis test.

Supernatant changes from 1) suernatant from fungus pellet when incubated with moss supernatant (Ph2-super-Tacro-SfallaxSupp) compared to 2) moss pellet only supernantant (Ph1-super-Sfallax).


```{r, echo=FALSE}

k<-met.dat %>% select(treat_cond, JGI_compound_id, peak_ht) %>% filter(treat_cond %in% c("Ph2-super-Tacro-SfallaxSupp", "Ph1-super-Sfallax"))

#to account for the dillution from phase 1 to phase 2
k<-k %>% mutate(peak_ht = ifelse(treat_cond == "Ph1-super-Sfallax", peak_ht/2, peak_ht * 1))
k$JGI_compound_id <- as.factor(k$JGI_compound_id)
k$treat_cond <- as.factor(k$treat_cond)

#Kruskal Wallis test
l<- k %>% group_by(JGI_compound_id) %>% do(tidy(kruskal.test(x= .$peak_ht, g = .$treat_cond))) %>% select(JGI_compound_id, statistic, p.value)

#datatable creation
m <-k %>% filter(treat_cond == "Ph2-super-Tacro-SfallaxSupp") %>% group_by(JGI_compound_id) %>% mutate(mean_Pelfung_SupMoss = mean(peak_ht)) %>% select(JGI_compound_id, mean_Pelfung_SupMoss) %>% unique()

m2 <- k %>% filter(treat_cond == "Ph1-super-Sfallax") %>% group_by(JGI_compound_id) %>% mutate(mean_super_moss = mean(peak_ht)) %>% select(JGI_compound_id, mean_super_moss) %>% unique()

m3 <- left_join(m,m2, by = "JGI_compound_id") %>% mutate(met_direction = ifelse(mean_Pelfung_SupMoss > mean_super_moss, "eluted_by fungus",  "uptake_up by fungus"))

crossfeed_PelFung_MossSuper<- met.dat %>% select(JGI_compound_id, compound_atlas_ID, label, Identified_metabolite) %>% unique()

crossfeed_PelFung_MossSuper$JGI_compound_id <-as.factor(crossfeed_PelFung_MossSuper$JGI_compound_id)
crossfeed_PelFung_MossSuper$compound_atlas_ID <-as.factor(crossfeed_PelFung_MossSuper$compound_atlas_ID)
crossfeed_PelFung_MossSuper$Identified_metabolite <-as.factor(crossfeed_PelFung_MossSuper$Identified_metabolite)

crossfeed_PelFung_MossSuper<-as.data.frame(crossfeed_PelFung_MossSuper)
m3<-as.data.frame(m3)
crossfeed_PelFung_MossSuper <- left_join(m3, crossfeed_PelFung_MossSuper, by = "JGI_compound_id")

crossfeed_PelFung_MossSuper<-left_join(l, crossfeed_PelFung_MossSuper, by = "JGI_compound_id")
crossfeed_PelFung_MossSuper<-crossfeed_PelFung_MossSuper %>% arrange(p.value)

#output
kable(crossfeed_PelFung_MossSuper[1:8, c(-1, -2, -4,-5)], caption = "Header- crossfed fungus pellet with moss supernatant")


num_sig_elluted<-nrow(crossfeed_PelFung_MossSuper %>% filter(p.value <= 0.05 & met_direction == "eluted_by fungus"))
num_sig_uptake<-nrow(crossfeed_PelFung_MossSuper %>% filter(p.value <= 0.05 & met_direction == "uptake_up by fungus"))

print(paste("# elluted fungal metabolites (p.value <= 0.05) is:", num_sig_elluted))
print(paste("# taken fungal metabolites (p.value <= 0.05) is:", num_sig_uptake))

#write_excel_csv(crossfeed_PelFung_MossSuper, "crossfeed_output_PelFung_MossSuper_halfstrength.csv")

```













